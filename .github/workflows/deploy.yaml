name: "Deploy application"
on:
  workflow_run:
    workflows: ["Docker push utenlandsadresser"]
    types:
      - completed

jobs:
  deploy-dev:
    name: "Deploy to DEV"
    if: github.ref == 'refs/heads/main' && github.event.workflow_run.conclusion == 'success'
    runs-on: "ubuntu-20.04"
    environment: dev-gcp
    permissions:
      id-token: "write"
    steps:
      - uses: "actions/checkout@v4"
      - name: "Deploy to DEV"
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: "nais/deploy/actions/deploy@v2"
        env:
          CLUSTER: "dev-gcp"
          RESOURCE: ".nais/nais.yaml"
          VAR: "image=${{ github.event.workflow_run.outputs.image }}"
          VARS: ".nais/dev.yaml"

  deploy-prod:
    name: "Deploy to PROD"
    if: github.ref == 'refs/heads/main' && github.event.workflow_run.conclusion == 'success'
    runs-on: "ubuntu-20.04"
    environment: prod-gcp
    permissions:
      id-token: "write"
    steps:
      - uses: "actions/checkout@v4"
      - name: "Deploy to PROD"
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: "nais/deploy/actions/deploy@v2"
        env:
          CLUSTER: "prod-gcp"
          RESOURCE: ".nais/nais.yaml"
          VAR: "image=${{ github.event.workflow_run.outputs.image }}"
          VARS: ".nais/prod.yaml"
